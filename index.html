<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interpolation Search Visualizer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6; /* A slightly softer gray */
        }
        /* Custom styles for array boxes */
        .array-box {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #cbd5e1; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            transition: all 0.3s ease-in-out;
            position: relative; /* For labels */
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        /* ... existing array-box styles (low, high, probe, etc.) ... */
        /* Labels for low, high, probe */
        .array-box::before {
            content: attr(data-label);
            position: absolute;
            top: -24px;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            padding: 2px 6px;
            border-radius: 0.375rem; /* rounded-md */
            color: white;
            opacity: 0;
            transition: all 0.3s ease-in-out;
            z-index: 10;
        }
        .array-box.low {
            border-color: #3b82f6; /* blue-500 */
            background-color: #dbeafe; /* blue-100 */
        }
        .array-box.low::before {
            content: 'low';
            background-color: #3b82f6; /* blue-500 */
            opacity: 1;
        }
        .array-box.high {
            border-color: #ef4444; /* red-500 */
            background-color: #fee2e2; /* red-100 */
        }
        .array-box.high::before {
            content: 'high';
            background-color: #ef4444; /* red-500 */
            opacity: 1;
        }
        .array-box.probe {
            border-color: #22c55e; /* green-500 */
            background-color: #dcfce7; /* green-100 */
            transform: scale(1.1);
            box-shadow: 0 10px 15px -3px rgba(34, 197, 94, 0.3);
        }
        .array-box.probe::before {
            content: 'probe';
            background-color: #22c55e; /* green-500 */
            opacity: 1;
        }
        .array-box.found {
            border-color: #f59e0b; /* amber-500 */
            background-color: #fef3c7; /* amber-100 */
            transform: scale(1.2);
            animation: bounce 0.5s;
        }
        .array-box.found::before {
            content: 'Found!';
            background-color: #f59e0b; /* amber-500 */
            opacity: 1;
        }
        .array-box.disabled {
            background-color: #f9fafb; /* gray-50 */
            color: #9ca3af; /* gray-400 */
            opacity: 0.7;
            box-shadow: none;
        }
        @keyframes bounce {
            0%, 100% { transform: scale(1.2) translateY(0); }
            50% { transform: scale(1.2) translateY(-10px); }
        }

        /* NEW: Styles for code highlighting */
        #code-container pre code span {
            display: block;
            padding: 1px 0;
            transition: all 0.2s ease-in-out;
        }
        .code-line-highlight {
            background-color: #fef08a; /* yellow-200 */
            color: #374151; /* gray-800 */
            display: block;
            border-left: 4px solid #f59e0b; /* amber-500 */
            margin: 0 -1rem; /* Extend highlight to full width of padding */
            padding: 0 1rem;
            font-weight: bold;
        }

        /* Style for formula logs */
        .formula-log {
            font-family: 'Courier New', Courier, monospace;
            background-color: #f3f4f6; /* gray-100 */
            padding: 0.75rem; /* p-3 */
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #e5e7eb; /* gray-200 */
            margin-top: 0.5rem; /* mt-2 */
            margin-bottom: 0.5rem; /* mb-2 */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.5; /* leading-relaxed */
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Styles for new Visual Formula - More descriptive */
        .formula-box {
            background-color: #374151; /* gray-800 */
            color: #d1d5db; /* gray-300 */
            padding: 1.25rem; /* p-5 */
            border-radius: 0.5rem; /* rounded-lg */
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem; /* text-sm */
            line-height: 1.6;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .formula-step {
            display: grid;
            grid-template-columns: 160px 1fr;
            align-items: center;
            gap: 1rem;
            margin-top: 0.75rem; /* mt-3 */
            padding-bottom: 0.75rem; /* pb-3 */
            border-bottom: 1px dashed #4b5563; /* gray-600 */
        }
        .formula-step:last-child {
            border-bottom: none;
        }
        .formula-label {
            font-weight: bold;
            color: #9ca3af; /* gray-400 */
            text-align: right;
        }
        .formula-calc {
            color: #f9fafb; /* gray-50 */
            font-weight: bold;
        }
        .var-val {
            background-color: #4b5563; /* gray-600 */
            color: #e5e7eb; /* gray-200 */
            padding: 2px 8px;
            border-radius: 4px;
            transition: all 0.2s ease-in-out;
            display: inline-block;
        }
        .var-val.updated {
            background-color: #34d399; /* emerald-400 */
            color: #111827; /* gray-900 */
            transform: scale(1.15);
        }
        .final-result {
            background-color: #1f2937; /* gray-900 */
            color: #34d399; /* emerald-400 */
            padding: 0.75rem; /* p-3 */
            border-radius: 0.375rem; /* rounded-md */
            text-align: center;
            font-size: 1.5rem; /* text-2xl */
            margin-top: 1rem; /* mt-4 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div classa="w-full bg-white rounded-xl shadow-xl p-6 md:p-8">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-blue-600 mb-6">
                Interpolation Search Visualizer
            </h1>

            <!-- Input Section -->
            <div class="p-4 border border-gray-200 rounded-lg bg-white mb-6 shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="array-input" class="block text-sm font-medium text-gray-700 mb-1">
                            Numbers (comma-separated)
                        </label>
                        <input type="text" id="array-input" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 5, 3, 22, 1, 10, 15, 8">
                    </div>
                    <div>
                        <label for="target-input" class="block text-sm font-medium text-gray-700 mb-1">
                            Target to Find
                        </label>
                        <input type="number" id="target-input" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 22">
                    </div>
                </div>
                <!-- Random Array Generator -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 pt-4 border-t border-gray-200">
                    <div class="md:col-span-2">
                        <label for="random-count" class="block text-sm font-medium text-gray-700 mb-1">
                            ...or Generate Random Array
                        </label>
                        <input type="number" id="random-count" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="How many numbers? (e.g., 10)">
                    </div>
                    <div class="flex items-end">
                        <button id="generate-random" class="w-full p-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition-all duration-300 h-full">
                            Generate
                        </button>
                    </div>
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex justify-center mb-6 gap-4">
                <button id="start-button" class="w-full md:w-1/3 p-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 text-lg">
                    Start Visualization
                </button>
                <button id="next-step-button" class="w-full md:w-1/3 p-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition-all duration-300 text-lg hidden">
                    Next Step ➔
                </button>
                <button id="reset-button" class="w-full md:w-1/3 p-3 bg-gray-500 text-white font-bold rounded-lg shadow-md hover:bg-gray-600 transition-all duration-300 text-lg hidden">
                    Reset
                </button>
            </div>

            <!-- NEW: Core Concept Box -->
            <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 rounded-lg shadow-sm mb-8" role="alert">
                <div class="flex">
                    <div class="py-1"><svg class="fill-current h-6 w-6 text-blue-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zM9 11v-2h2v2H9zm0 4v-2h2v2H9z"/></svg></div>
                    <div>
                        <p class="font-bold">How It "Thinks"</p>
                        <p class="text-sm">Interpolation Search guesses where to look. If you're looking for "Steve" in a phone book, you wouldn't start at 'A'. You'd guess it's near the 'S' section. This search does the same with numbers, assuming they are evenly spread out.</p>
                    </div>
                </div>
            </div>

            <!-- Visualization Area -->
            <div class="bg-white rounded-xl shadow-xl p-6 md:p-8 mb-8">
                <h2 class="text-2xl font-semibold mb-6 text-center">Array Visualization</h2>
                <div id="array-container" class="w-full min-h-[150px] p-4 border-2 border-dashed border-gray-300 rounded-lg flex flex-wrap justify-center items-start gap-3 md:gap-4 pt-8">
                    <span class="text-gray-400">Enter data and press 'Start' to see the visualization.</span>
                </div>
            </div>
            
            <!-- NEW: Two-Column Layout for logs and formula -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- Column 1: Formula + Code -->
                <div>
                    <!-- Visual Formula (Redesigned) -->
                    <div id="visual-formula-container" class="bg-white rounded-xl shadow-xl p-6 md:p-8 hidden">
                        <h2 class="text-2xl font-semibold mb-4 text-center">Live Formula Breakdown</h2>
                        <!-- **** THIS IS THE FIXED BLOCK **** -->
                        <div class="formula-box">
                            <div class="text-center text-gray-400 mb-4">pos = low + (Proportion * Index Range)</div>
                            
                            <div class="formula-step">
                                <span class="formula-label">Value's Position</span>
                                <span class="formula-calc">(target - arr[low]) = <span id="vf-target" class="var-val">?</span> - <span id="vf-arr-low" class="var-val">?</span> = <span id="vf-val-pos" class="var-val">?</span></span>
                            </div>
                            
                            <div class="formula-step">
                                <span class="formula-label">Value Range</span>
                                <span class="formula-calc">(arr[high] - arr[low]) = <span id="vf-arr-high" class="var-val">?</span> - <span id="vf-arr-low-2" class="var-val">?</span> = <span id="vf-val-range" class="var-val">?</span></span>
                            </div>

                            <div class="formula-step">
                                <span class="formula-label">Proportion</span>
                                <span class="formula-calc">(Position / Range) = <span id="vf-val-pos-2" class="var-val">?</span> / <span id="vf-val-range-2" class="var-val">?</span> = <span id="vf-proportion" class="var-val">?</span></span>
                            </div>
                            
                            <div class="formula-step">
                                <span class="formula-label">Index Range</span>
                                <span class="formula-calc">(high - low) = <span id="vf-high" class="var-val">?</span> - <span id="vf-low" class="var-val">?</span> = <span id="vf-index-range" class="var-val">?</span></span>
                            </div>
                            
                            <div class="final-result">
                                pos = <span id="vf-low-2" class="var-val">?</span> + (<span id="vf-proportion-2" class="var-val">?</span> * <span id="vf-index-range-2" class="var-val">?</span>) = <span id="vf-result" class="var-val">?</span>
                            </div>
                        </div>
                        <!-- **** END OF FIXED BLOCK **** -->
                    </div>

                    <!-- NEW: Code Container -->
                    <div id="code-container" class="bg-white rounded-xl shadow-xl p-6 md:p-8 mt-8 hidden">
                        <h2 class="text-2xl font-semibold mb-4 text-center">C++ Code</h2>
                        <div class="bg-gray-900 text-gray-300 rounded-lg p-4 overflow-x-auto text-sm">
                            <pre><code class="language-cpp">
<span id="code-line-1">int interpolationSearch(int array[], int n, int value) {</span>
<span id="code-line-2">    int high = n - 1;</span>
<span id="code-line-3">    int low = 0;</span>
<span id="code-line-4">    </span>
<span id="code-line-5">    while (value >= array[low] && value <= array[high] && low<=high) {</span>
<span id="code-line-6">        if (array[high] == array[low]) {</span>
<span id="code-line-7">            if (array[low] == value)</span>
<span id="code-line-8">                return low;</span>
<span id="code-line-9">            else</span>
<span id="code-line-10">                break;</span>
<span id="code-line-11">        }</span>
<span id="code-line-12"></span>
<span id="code-line-13">        int probe = low + (high-low) * (value - array[low]) / (array[high] - array[low]);</span>
<span id="code-line-14">        </span>
<span id="code-line-15">        if (array[probe]==value) {</span>
<span id="code-line-16">            return probe;</span>
<span id="code-line-17">        }</span>
<span id="code-line-18">        else if (array[probe]>value) {</span>
<span id="code-line-19">            high = probe - 1;</span>
<span id="code-line-20">        }</span>
<span id="code-line-21">        else {</span>
<span id="code-line-22">            low = probe + 1;</span>
<span id="code-line-23">        }</span>
<span id="code-line-24">    }</span>
<span id="code-line-25">    </span>
<span id="code-line-26">    return -1;</span>
<span id="code-line-27">}</span>
                            </code></pre>
                        </div>
                    </div>
                </div>

                <!-- Column 2: Explanation Log -->
                <div class="bg-white rounded-xl shadow-xl p-6 md:p-8">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Step-by-Step Explanation</h2>
                    <div id="explanation-log" class="w-full h-96 overflow-y-auto p-4 border border-gray-300 rounded-lg bg-gray-50 shadow-inner">
                        <span class="text-gray-400">Detailed steps will appear here...</span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const arrayInput = document.getElementById('array-input');
        const targetInput = document.getElementById('target-input');
        const randomCountInput = document.getElementById('random-count');
        const generateRandomButton = document.getElementById('generate-random');
        const startButton = document.getElementById('start-button');
        const nextStepButton = document.getElementById('next-step-button'); // New button
        const resetButton = document.getElementById('reset-button');
        const arrayContainer = document.getElementById('array-container');
        const explanationLog = document.getElementById('explanation-log');
        const visualFormulaContainer = document.getElementById('visual-formula-container');
        const codeContainer = document.getElementById('code-container'); // NEW

        // Visual Formula DOM Elements
        const vf = {
            target: document.getElementById('vf-target'),
            arrLow: document.getElementById('vf-arr-low'),
            valPos: document.getElementById('vf-val-pos'),
            
            arrHigh: document.getElementById('vf-arr-high'),
            arrLow2: document.getElementById('vf-arr-low-2'),
            valRange: document.getElementById('vf-val-range'),

            valPos2: document.getElementById('vf-val-pos-2'),
            valRange2: document.getElementById('vf-val-range-2'),
            proportion: document.getElementById('vf-proportion'),
            
            high: document.getElementById('vf-high'),
            low: document.getElementById('vf-low'),
            indexRange: document.getElementById('vf-index-range'),
            
            low2: document.getElementById('vf-low-2'),
            proportion2: document.getElementById('vf-proportion-2'),
            indexRange2: document.getElementById('vf-index-range-2'),
            result: document.getElementById('vf-result')
        };
        // This was the source of the error. This line was trying to read properties
        // of 'null' because the HTML was missing.
        const allVfSpans = Object.values(vf);

        // Global state object for manual stepping
        let vizState = {
            isRunning: false,
            step: 'probe', // 'probe' or 'compare'
            sortedArray: [],
            target: 0,
            low: 0,
            high: 0,
            pos: -1,
            stepCount: 1
        };

        let currentHighlight = null; // NEW: For code highlighting

        // Helper: Flash effect for updated values
        function flashUpdate(elements) {
            // ... (same as before)
            const elementsToFlash = Array.isArray(elements) ? elements : [elements];
            elementsToFlash.forEach(el => {
                if (el) { // Check if element exists
                    el.classList.add('updated');
                    setTimeout(() => {
                        el.classList.remove('updated');
                    }, 500); // Duration of the flash
                }
            });
        }

        // Helper: Update Visual Formula
        function updateVisualFormula(lowVal, highVal, targetVal, arrLowVal, arrHighVal) {
            // This function will no longer throw an error
            const valPos = (targetVal - arrLowVal);
            const valRange = (arrHighVal - arrLowVal);
            const proportion = (valRange === 0) ? 0 : (valPos / valRange);
            const indexRange = (highVal - lowVal);
            const pos = lowVal + Math.floor(proportion * indexRange);
            vf.target.textContent = targetVal;
            vf.arrLow.textContent = arrLowVal;
            vf.valPos.textContent = valPos;
            vf.arrHigh.textContent = arrHighVal;
            vf.arrLow2.textContent = arrLowVal;
            vf.valRange.textContent = valRange;
            vf.valPos2.textContent = valPos;
            vf.valRange2.textContent = valRange;
            vf.proportion.textContent = proportion.toFixed(3);
            vf.high.textContent = highVal;
            vf.low.textContent = lowVal;
            vf.indexRange.textContent = indexRange;
            vf.low2.textContent = lowVal;
            vf.proportion2.textContent = proportion.toFixed(3);
            vf.indexRange2.textContent = indexRange;
            vf.result.textContent = pos;
            flashUpdate(allVfSpans);
            visualFormulaContainer.classList.remove('hidden');
        }

        // Helper: Reset Visual Formula
        function resetVisualFormula() {
            // Reset all spans, checking if they exist first
            allVfSpans.forEach(span => {
                if(span) span.textContent = '?';
            });
            visualFormulaContainer.classList.add('hidden');
        }

        // NEW: Helper: Highlight a line of code
        function highlightCode(lineId) {
            if (currentHighlight) {
                currentHighlight.classList.remove('code-line-highlight');
            }
            if (lineId) {
                const line = document.getElementById(lineId);
                if (line) {
                    line.classList.add('code-line-highlight');
                    currentHighlight = line;
                }
            } else {
                currentHighlight = null;
            }
        }

        // Helper: Log a step
        function logStep(message, isFormula = false) {
            // ... (same as before)
            if (isFormula) {
                const logEntry = document.createElement('div');
                logEntry.className = 'formula-log';
                logEntry.innerHTML = message;
                explanationLog.appendChild(logEntry);
            } else {
                const logEntry = document.createElement('div');
                logEntry.className = 'p-2 border-b border-gray-200';
                logEntry.innerHTML = message;
                explanationLog.appendChild(logEntry);
            }
            explanationLog.scrollTop = explanationLog.scrollHeight;
        }

        // Helper: Render the array
        function renderArray(arr, low = -1, high = -1, probe = -1, found = -1) {
            // ... (same as before)
            arrayContainer.innerHTML = '';
            arr.forEach((value, index) => {
                const elementWrapper = document.createElement('div'); // NEW wrapper
                elementWrapper.className = 'flex flex-col items-center';

                const box = document.createElement('div');
                box.className = 'array-box';
                box.textContent = value;
                if (index === low) box.classList.add('low');
                if (index === high) box.classList.add('high');
                if (index === probe) box.classList.add('probe');
                if (index === found) box.classList.add('found');
                if ((low !== -1 && index < low) || (high !== -1 && index > high)) {
                    box.classList.add('disabled');
                }
                
                elementWrapper.appendChild(box); // Add box to wrapper

                const indexLabel = document.createElement('div'); // NEW index label
                indexLabel.className = 'text-sm font-semibold text-gray-500 mt-1';
                indexLabel.textContent = index;
                elementWrapper.appendChild(indexLabel); // Add label to wrapper

                arrayContainer.appendChild(elementWrapper); // Add wrapper to container
            });
        }

        // --- NEW/MODIFIED FUNCTIONS ---

        // Manages button visibility
        function setButtonState(state) {
            if (state === 'idle') {
                startButton.classList.remove('hidden');
                nextStepButton.classList.add('hidden');
                resetButton.classList.add('hidden');
            } else if (state === 'active') {
                startButton.classList.add('hidden');
                nextStepButton.classList.remove('hidden');
                resetButton.classList.remove('hidden');
            } else if (state === 'complete') {
                startButton.classList.add('hidden');
                nextStepButton.classList.add('hidden');
                resetButton.classList.remove('hidden');
            }
        }

        // Main setup function (formerly startVisualization)
        function initializeSearch() {
            // 1. Get and parse inputs
            const rawArray = arrayInput.value.split(',')
                                .map(s => s.trim())
                                .filter(s => s !== '')
                                .map(Number)
                                .filter(isFinite);
            const target = Number(targetInput.value);

            if (rawArray.length === 0) {
                logStep("<strong>Error:</strong> Please enter a valid array of numbers.");
                return;
            }
            if (isNaN(target)) {
                logStep("<strong>Error:</strong> Please enter a valid target number.");
                return;
            }

            // 2. Clear logs and sort the array
            explanationLog.innerHTML = '';
            resetVisualFormula();
            logStep(`<strong>Starting search for ${target}</strong> in array: [${rawArray.join(', ')}]`);
            logStep(`Interpolation search requires a <strong>sorted array</strong>. Sorting...`);
            
            const sorted = [...new Set(rawArray)].sort((a, b) => a - b);
            if (sorted.length < rawArray.length) {
                logStep(`Note: Duplicates were removed for a cleaner search.`);
            }
            renderArray(sorted);
            logStep(`Sorted array: [<strong>${sorted.join(', ')}</strong>]`);

            // 3. Initialize search state
            vizState = {
                isRunning: true,
                step: 'probe',
                sortedArray: sorted,
                target: target,
                low: 0,
                high: sorted.length - 1,
                pos: -1,
                stepCount: 1
            };
            
            // 4. Set UI to active
            setButtonState('active');
            codeContainer.classList.remove('hidden'); // NEW
            highlightCode('code-line-3'); // NEW
        }

        // Function to finish the search
        function finishSearch(found, foundIndex = -1) {
            vizState.isRunning = false;
            setButtonState('complete');

            if (found) {
                logStep(`<strong>Found!</strong> arr[${foundIndex}] (${vizState.sortedArray[foundIndex]}) == target (${vizState.target})`);
                renderArray(vizState.sortedArray, -1, -1, -1, foundIndex);
                highlightCode('code-line-16'); // NEW
            } else {
                logStep(`<h3 class="text-lg font-bold mt-4">Search Finished</h3>`);
                // Add reason for stopping
                if (vizState.low > vizState.high) {
                    logStep(`Condition failed (low > high).`);
                } else if (vizState.target < vizState.sortedArray[vizState.low]) {
                    logStep(`Condition failed (target < arr[low] -> ${vizState.target} < ${vizState.sortedArray[vizState.low]}).`);
                } else if (vizState.target > vizState.sortedArray[vizState.high] && vizState.high >= 0) {
                    logStep(`Condition failed (target > arr[high] -> ${vizState.target} > ${vizState.sortedArray[vizState.high]}).`);
                } else {
                    logStep(`Target is not within the remaining search range.`);
                }
                logStep(`<strong>Target ${vizState.target} not found in the array.</strong>`);
                renderArray(vizState.sortedArray, -1, -1, -1, -1);
                highlightCode('code-line-26'); // NEW
            }
        }
        
        // This function runs ONE part of the step (probe or compare)
        function performNextStep() {
            if (!vizState.isRunning) return;

            const { sortedArray, target, low, high } = vizState;

            if (vizState.step === 'probe') {
                // Check loop conditions
                highlightCode('code-line-5'); // NEW
                if (low > high || target < sortedArray[low] || target > sortedArray[high]) {
                    finishSearch(false);
                    return;
                }

                logStep(`<h3 class="text-lg font-bold mt-4">Step ${vizState.stepCount} (Probe)</h3>`);
                logStep(`Range: <strong>low = ${low}</strong> (value: ${sortedArray[low]}), <strong>high = ${high}</strong> (value: ${sortedArray[high]})`);
                renderArray(sortedArray, low, high);

                // Handle edge case
                if (low === high) {
                    highlightCode('code-line-6'); // NEW
                    if (sortedArray[low] === target) {
                        logStep(`low == high. Checking arr[${low}]...`);
                        highlightCode('code-line-7'); // NEW
                        finishSearch(true, low);
                    } else {
                        logStep(`low == high, but arr[${low}] (${sortedArray[low]}) != target (${target}).`);
                        highlightCode('code-line-10'); // NEW
                        finishSearch(false);
                    }
                    return;
                }
                
                // Calculate position
                updateVisualFormula(low, high, target, sortedArray[low], sortedArray[high]);
                logStep("<strong>Calculating probe position...</strong> (see formula breakdown)");
                highlightCode('code-line-13'); // NEW

                let valPos = (target - sortedArray[low]);
                let valRange = (sortedArray[high] - sortedArray[low]);
                let indexRange = (high - low);
                let proportion = (valRange === 0) ? 0 : (valPos / valRange);
                let pos = low + Math.floor(proportion * indexRange);
                
                // Handle out-of-bounds probe
                if (pos < low || pos > high) {
                     logStep(`<span class="text-red-600 font-bold">Calculated position <strong>${pos}</strong> is out of bounds [${low}, ${high}].</span>`);
                     logStep(`This can happen with non-uniformly distributed data.`);
                     finishSearch(false);
                     return;
                }
                
                vizState.pos = pos; // Save position for compare step
                logStep(`Probing index <strong>${pos}</strong> (value: <strong class="text-green-600">${sortedArray[pos]}</strong>)`);
                renderArray(sortedArray, low, high, pos);
                
                vizState.step = 'compare'; // Set state for next click
                highlightCode('code-line-15'); // NEW

            } else if (vizState.step === 'compare') {
                logStep(`<h3 class="text-lg font-bold mt-4">Step ${vizState.stepCount} (Compare)</h3>`);
                const { pos } = vizState;

                if (sortedArray[pos] === target) {
                    finishSearch(true, pos);
                    return;
                } else if (sortedArray[pos] < target) {
                    logStep(`Value is <strong>too low</strong> (${sortedArray[pos]} < ${target}).`);
                    vizState.low = pos + 1;
                    logStep(`Setting <strong>low ➔ ${vizState.low}</strong>`);
                    highlightCode('code-line-22'); // NEW
                } else {
                    logStep(`Value is <strong>too high</strong> (${sortedArray[pos]} > ${target}).`);
                    vizState.high = pos - 1;
                    logStep(`Setting <strong>high ➔ ${vizState.high}</strong>`);
                    highlightCode('code-line-19'); // NEW
                }
                
                // Render array with new bounds (probe is gone)
                renderArray(sortedArray, vizState.low, vizState.high);
                
                vizState.step = 'probe'; // Set state for next click
                vizState.stepCount++;
            }
        }

        // Full reset of the app
        function fullReset() {
            vizState.isRunning = false;
            vizState.step = 'probe';
            vizState.stepCount = 1;
            sortedArray = [];
            arrayInput.value = '';
            targetInput.value = '';
            randomCountInput.value = '';
            arrayContainer.innerHTML = '<span class="text-gray-400">Enter data and press \'Start\' to see the visualization.</span>';
            explanationLog.innerHTML = '<span class="text-gray-400">Detailed steps will appear here...</span>';
            resetVisualFormula();
            setButtonState('idle');
            codeContainer.classList.add('hidden'); // NEW
            highlightCode(null); // NEW
        }

        // Generate Random Array
        function generateRandom() {
            const count = Number(randomCountInput.value);
            if (count <= 0 || count > 100) {
                // Use a custom modal or inline message instead of alert
                logStep("<strong>Error:</strong> Please enter a number between 1 and 100 for random generation.");
                return;
            }
            
            let randomNumbers = new Set();
            while(randomNumbers.size < count) {
                // Generate numbers between 1 and 200
                randomNumbers.add(Math.floor(Math.random() * 200) + 1);
            }
            
            arrayInput.value = Array.from(randomNumbers).join(', ');
        }

        // Event Listeners
        startButton.addEventListener('click', initializeSearch);
        nextStepButton.addEventListener('click', performNextStep); // New listener
        resetButton.addEventListener('click', fullReset);
        generateRandomButton.addEventListener('click', generateRandom);

    </script>
</body>
</html>

